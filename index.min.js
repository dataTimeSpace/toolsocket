class e{constructor(){this.eCb={}}on(e,...t){this.eCb[e]||(this.eCb[e]=[]),this.eCb[e].push(...t)}emit(e,...t){this.eCb[e]&&this.eCb[e].forEach((e=>e(...t)))}removeAllListeners(){for(let e in this.eCb)delete this.eCb[e]}validate=(e,t,i)=>{if("object"!=typeof e)return!1;let s=(e,t,i)=>"string"==typeof e[i]&&(!(Number.isInteger(t[i].minLength)&&e[i].length<t[i].minLength)&&(!(Number.isInteger(t[i].maxLength)&&e[i].length>t[i].maxLength)&&(!(t[i].pattern&&!e[i].match(t[i].pattern))&&!(t[i].enum&&!t[i].enum.includes(e[i]))))),n=(e,t,i)=>!!Number.isInteger(e[i])&&(!(Number.isInteger(t[i].minimum)&&e[i]<t[i].minimum)&&!(Number.isInteger(t[i].maximum)&&e[i]>t[i].maximum)),r=(e,t,i)=>("res"!==e.m||null!==e[i])&&null===e[i],o=(e,t,i)=>"boolean"==typeof e[i],h=(e,t,i)=>"number"==typeof e[i],c=(e,t,i)=>!e[i],a=(e,t,i,s)=>!!Array.isArray(e[i])&&(!(Number.isInteger(t[i].minLength)&&s<t[i].minLength)&&!(Number.isInteger(t[i].maxLength)&&s>t[i].maxLength)),l=(e,t,i,s)=>{if("object"==typeof e[i])return!(Number.isInteger(t[i].minLength)&&s<t[i].minLength)&&!(Number.isInteger(t[i].maxLength)&&s>t[i].maxLength)},p=(e,t,i)=>t.hasOwnProperty(i),u=i.items.properties,g=!0;for(let i in e)if(p(0,u,i)){let p=!1;u[i].type.includes("string")&&s(e,u,i)&&(p=!0),u[i].type.includes("integer")&&n(e,u,i)&&(p=!0),u[i].type.includes("null")&&r(e,0,i)&&(p=!0),u[i].type.includes("boolean")&&o(e,0,i)&&(p=!0),u[i].type.includes("number")&&h(e,0,i)&&(p=!0),u[i].type.includes("array")&&a(e,u,i,t)&&(p=!0),u[i].type.includes("object")&&l(e,u,i,t)&&(p=!0),u[i].type.includes("undefined")&&c(e,0,i)&&(p=!0),p||(g=!1)}else g=!1;return((e,t)=>{for(let i in t)if(!e.hasOwnProperty(t[i]))return!1;return!0})(e,i.items.required)||(g=!1),g};parseUrl=(e,t)=>{let i=e.split("://"),s=null,n=null;i&&i[1]&&(e=i[1],s=i[0]);let r=e.split("/");s&&(n=r[0],r.shift());let o={},h="",c=[];r[r.length-1]&&(c=r[r.length-1].split("?"));let a=null;c&&c[0]&&(a=c[0].split("."),c[1]&&(r[r.length-1]=c[0]));try{t.items.properties.type||(t.items.properties.type={type:"string",minLength:1,maxLength:5,enum:["jpg","jpeg","gif","zip","glb","html","htm","xml","dat","png","js","json","obj","fbx","svg","mp4","pdf","csv","css"]}),t.items.properties.protocol||(t.items.properties.protocol={type:"string",minLength:1,maxLength:20,enum:["spatialtoolbox","ws","wss","http","https"]}),t.items.properties.query||(t.items.properties.query={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9~!@$%^&*()-_=+|;:,.]"}),t.items.properties.server||(t.items.properties.server={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9~!@$%^&*()-_=+|;:,.]"}),t.items.properties.route||(t.items.properties.route={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9/~!@$%^&*()-_=+|;:,.]*$"});for(let e=0;e<r.length;e++)t.items.expected.includes(r[e])?(r[e+1]&&(o[r[e]]=r[e+1]),e++):r[e]&&(h=h+"/"+r[e])}catch(e){return null}return c&&c[1]&&(o.query=c[1]),h&&(o.route=h),n&&(o.server=n),s&&(o.protocol=s),a&&a.length>1&&(o.type=a[a.length-1]),this.validate(o,e.length,t)?o:null};uuidShort=e=>{let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",i="";for(;i.length<e;)i=t.charAt(Math.floor(Math.random()*t.length))+i;return i}}class t extends e{constructor(e,t,i){super();let s=this;this.retryAmount=5,this.timetoRequestPackage=3e3,this.netBeatInterval=1e3,this.networkID=t,this.url=e,this.origin=i,this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.id=0,this.readyState=3,this.rsOld=null,this.packageID=0,this.packageCb={},this.routineIntervalRef=null,this.netBeatIntervalRef=null,this.envNode=!1,this.isServer=!1,this.CbObj=function(e,t,i){this.callback=e,this.time=t,this.retry=0,this.msg=i},this.CbSub=function(e,t){this.route=e,this.socket=t},this.DataPackage=function(e,t,i,s,n,r=null){this.i=r,this.o=e,this.n=t,this.m=i,this.r=s,this.b=n,this.s=null},this.dataPackageSchema={type:"object",items:{properties:{i:{type:["string","null","undefined"],minLength:1,maxLength:22,pattern:"^[A-Za-z0-9_]*$"},o:{type:"string",minLength:1,maxLength:10,enum:["server","client","web","edge","proxy"]},n:{type:"string",minLength:1,maxLength:25,pattern:"^[A-Za-z0-9_]*$"},m:{type:"string",minLength:1,maxLength:10,enum:["beat","action","ping","get","post","put","patch","delete","new","unsub","sub","pub","message","io","res"]},r:{type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9_/?:&+.%=-]*$"},b:{type:["boolean","array","number","string","object"],minLength:0,maxLength:7e7},s:{type:["string","null","undefined"],minLength:0,maxLength:45,pattern:"^[A-Za-z0-9_]*$"}},required:["i","o","n","m","r","b"]}},this.Response=function(e){this.send=t=>{if(e.i){let i=new s.DataPackage(s.origin,e.n,"res",e.r,{},e.i);i.b=t||204,s.send(i)}}},this.router=e=>{let t;try{t=JSON.parse(e)}catch(e){return void console.log("no json")}s.validate(t,e.length,this.dataPackageSchema)?("ping"===t.m&&(s.send(new s.DataPackage(s.origin,t.n,"res",t.r,"pong",t.i)),s.networkID!==t.n&&(s.networkID=t.n,this.emit("network",t.n,s.networkID,t))),t.i&&"res"===t.m?this.packageCb.hasOwnProperty(t.i)&&(this.packageCb[t.i].callback(t.b),delete this.packageCb[t.i]):this.dataPackageSchema.items.properties.m.enum.includes(t.m)&&this.routerCallback(t)):console.log(t,"not allowed")},this.routerCallback=e=>{e.i?this.emit(e.m,e.r,e.b,new this.Response(e)):this.emit(e.m,e.r,e.b)},this.routineIntervalRef=setInterval(function(){this.readyState!==this.CLOSED&&this.readyState||this.isServer||this.connect(this.url,this.networkID,this.origin);for(let e in this.packageCb)this.timetoRequestPackage<Date.now()-this.packageCb[e].time&&this.packageCb.hasOwnProperty(e)&&(this.packageCb[e].retry++,this.retryAmount<this.packageCb[e].retry?delete this.packageCb[e]:(this.packageCb[e].time=Date.now(),this.resend(e)))}.bind(this),this.timetoRequestPackage),this.message=this.new=this.delete=this.patch=this.io=this.put=this.post=this.get=this.action=this.beat=(e,t,i)=>{};for(let e of this.dataPackageSchema.items.properties.m.enum)this[e]=(t,i,s)=>{this.send(new this.DataPackage(this.origin,this.networkID,e,t,i),s)};this.send=(e,t)=>{this.readyState===this.OPEN&&e&&("function"==typeof t?(this.packageID<Number.MAX_SAFE_INTEGER?this.packageID++:this.packageID=0,e.i=this.packageID+this.uuidShort(4),this.packageCb[e.i]=new this.CbObj(t,Date.now(),e)):"res"!==e.m&&(e.i=null),this.socket.send(JSON.stringify(e)))},this.resend=e=>{this.readyState===this.OPEN&&this.packageCb.hasOwnProperty(e)&&this.socket.send(JSON.stringify(this.packageCb[e].msg))},this.stateEmitter=(e,t)=>{this.readyState=t,this.emit(e,t),this.rsOld!==this.readyState&&(this.emit("status",this.readyState),this.rsOld=this.readyState)},this.attachEvents=()=>{this.envNode&&(this.socket.on("connected",(()=>{s.stateEmitter("connected",s.OPEN)})),this.socket.on("connecting",(()=>{s.stateEmitter("connecting",s.CONNECTING)}))),this.socket.onclose=()=>{s.stateEmitter("close",s.CLOSED)},this.socket.onopen=()=>{s.ping(),s.stateEmitter("open",s.OPEN)},this.socket.onerror=e=>{s.emit("error",e)},this.socket.onmessage=e=>{s.router(e.data)},this.close=()=>{this.socket.close(),this.removeAllListeners(),clearInterval(this.routineIntervalRef),clearInterval(this.netBeatIntervalRef)}},this.ping=()=>{let e=new s.DataPackage(this.origin,this.networkID,"ping","action/ping","");if(s.readyState===this.OPEN)try{s.send(e,(e=>{s.readyState="pong"===e||""===e?s.OPEN:s.CLOSED}),s.socket)}catch(e){s.readyState=s.CLOSED,console.log(e)}else s.readyState=s.CLOSED},this.setNetworkId=e=>this.networkID=e}}class i extends e{constructor(){super(),this.network=null,this.origin=null,this.socket=null,this.id=0,this.routeSchema={type:"object",items:{properties:{n:{type:"string",minLength:1,maxLength:25,pattern:"^[A-Za-z0-9_]*$"}},required:["n"],expected:["n"]}}}attachEvents(){this.socket.on("connected",(()=>{this.returnObject.connected=!0,this.emit("connected"),this.emit("connection"),this.emit("connect")})),this.socket.on("connecting",(()=>{this.emit("connecting")})),this.socket.on("close",(()=>{this.emit("disconnect"),this.returnObject.connected=!1,this.sockets&&this.sockets.connected&&this.returnObject&&this.returnObject.id&&delete this.sockets.connected[this.returnObject.id],this.emit("close"),this.removeAllListeners()})),this.socket.on("open",(()=>{this.returnObject.connected=!0,this.emit("connect"),this.emit("connection")})),this.socket.on("error",(e=>{this.emit("error",e)})),this.socket.on("io",((e,t)=>{this.emit(e,t)}))}connect(e,t,i){if(this.socket&&(this.returnObject.connected=!1,this.socket.close(),this.removeAllListeners()),this.origin="server",this.network="io",t&&(this.network=t),i&&(this.origin=i),"undefined"!=typeof window&&(this.origin="web"),!e&&"undefined"!=typeof window){let t={route:location.pathname,port:location.port,ip:location.hostname,protocol:location.protocol,ws:"ws://"};"https:"===t.protocol?t.ws="wss://":"http:"===t.protocol&&(t.ws="ws://"),e=t.ws+t.ip+":"+t.port+t.route}0===e.indexOf("http")&&(e=e.replace("http","ws"));let n=this.parseUrl(e,this.routeSchema);n&&n.n&&!t&&(this.network=n.n),this.socket=new s(e,this.network,this.origin),this.attachEvents();let r=this;return this.returnObject={on:(e,t)=>r.on(e,(e=>t(e))),emit:(e,t)=>r.socket.io(e,t),connected:!1},this.returnObject}}class s extends t{constructor(e,t,i){super(e,t,i);let s=this;if(this.WebSocket=null,this.socket=null,"undefined"==typeof window)this.WebSocket=require("ws"),this.envNode=!0;else if("undefined"!=typeof WebSocket)this.WebSocket=WebSocket;else if("undefined"!=typeof MozWebSocket)this.WebSocket=MozWebSocket;else if("undefined"!=typeof global)this.WebSocket=global.WebSocket||global.MozWebSocket;else if("undefined"!=typeof window)this.WebSocket=window.WebSocket||window.MozWebSocket;else{if("undefined"==typeof self)return void console.log("websocket not available");this.WebSocket=self.WebSocket||self.MozWebSocket}this.netBeatIntervalRef=setInterval((()=>{s.readyState===s.OPEN&&s.ping()}),s.netBeatInterval),this.connect=(e,t,i)=>{t&&(s.networkID=t),i&&(s.origin=i),s.socket&&(s.readyState=s.CLOSED,s.socket.close()),s.socket=new s.WebSocket(e),s.readyState=s.CONNECTING,this.attachEvents()},this.connect(this.url,this.networkID,this.origin)}static Server=class extends e{constructor(e,i){if(super(),this.origin=i||"server","undefined"!=typeof window)return;let s=this;console.log("Server init");let n=require("ws");this.server=new n.Server(e),this.server.on("connection",((e,...i)=>{s.emit("connection",new class extends t{constructor(e){super(void 0,void 0,s.origin),this._socket=e._socket,this.socket=e,this.envNode=!0,this.isServer=!0,this.readyState=this.OPEN,this.attachEvents()}}(e),...i)}))}};static Io=class extends i{constructor(e,t,i){super(e,t,i)}static Server=class extends e{constructor(e,t){if(super(),this.origin=t||"server","undefined"!=typeof window)return;let n=this;console.log("Server init"),this.id=1,this.sockets={connected:{}},this.server=new s.Server(e),this.server.on("connection",((e,...t)=>{n.id>=Number.MAX_SAFE_INTEGER&&(n.id=1),n.id++,n.sockets.connected[n.id]=new class extends i{constructor(e,...t){return super(e,...t),this.socket=e,this.sockets=n.sockets,this.socket.networkID="io",this.envNode=!0,this.isServer=!0,this.connect()}connect(){let e=this;return this.attachEvents(),this.returnObject={on:(t,i)=>e.on(t,(e=>i(e))),emit:(t,i)=>e.socket.io(t,i),connected:!0},this.returnObject}}(e),n.sockets.connected[n.id].id=n.id,n.emit("connection",n.sockets.connected[n.id],...t)}))}}}}if("undefined"==typeof window)module.exports=s;else var n=new s.Io;