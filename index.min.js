class t{constructor(){this.eCb={}}on(t,...e){this.eCb[t]||(this.eCb[t]=[]),this.eCb[t].push(...e)}emit(t,...e){this.eCb[t]&&this.eCb[t].forEach((t=>t(...e)))}removeAllListeners(){for(let t in this.eCb)delete this.eCb[t]}validate=(t,e,i)=>{if("object"!=typeof t)return!1;let s=(t,e,i)=>"string"==typeof t[i]&&(!(Number.isInteger(e[i].minLength)&&t[i].length<e[i].minLength)&&(!(Number.isInteger(e[i].maxLength)&&t[i].length>e[i].maxLength)&&(!(e[i].pattern&&!t[i].match(e[i].pattern))&&!(e[i].enum&&!e[i].enum.includes(t[i]))))),n=(t,e,i)=>!!Number.isInteger(t[i])&&(!(Number.isInteger(e[i].minimum)&&t[i]<e[i].minimum)&&!(Number.isInteger(e[i].maximum)&&t[i]>e[i].maximum)),r=(t,e,i)=>("res"!==t.m||null!==t[i])&&null===t[i],o=(t,e,i)=>"boolean"==typeof t[i],h=(t,e,i)=>"number"==typeof t[i],c=(t,e,i)=>!t[i],a=(t,e,i,s)=>!!Array.isArray(t[i])&&(!(Number.isInteger(e[i].minLength)&&s<e[i].minLength)&&!(Number.isInteger(e[i].maxLength)&&s>e[i].maxLength)),l=(t,e,i,s)=>{if("object"==typeof t[i])return!(Number.isInteger(e[i].minLength)&&s<e[i].minLength)&&!(Number.isInteger(e[i].maxLength)&&s>e[i].maxLength)},p=(t,e,i)=>e.hasOwnProperty(i),u=i.items.properties,m=!0;for(let i in t)if(p(0,u,i)){let p=!1;u[i].type.includes("string")&&s(t,u,i)&&(p=!0),u[i].type.includes("integer")&&n(t,u,i)&&(p=!0),u[i].type.includes("null")&&r(t,0,i)&&(p=!0),u[i].type.includes("boolean")&&o(t,0,i)&&(p=!0),u[i].type.includes("number")&&h(t,0,i)&&(p=!0),u[i].type.includes("array")&&a(t,u,i,e)&&(p=!0),u[i].type.includes("object")&&l(t,u,i,e)&&(p=!0),u[i].type.includes("undefined")&&c(t,0,i)&&(p=!0),p||(m=!1)}else m=!1;return((t,e)=>{for(let i in e)if(!t.hasOwnProperty(e[i]))return!1;return!0})(t,i.items.required)||(m=!1),m};parseUrl=(t,e)=>{let i=t.split("://"),s=null,n=null,r=null;i&&i[1]&&(t=i[1],s=i[0]);let o=t.split("/");if(s){n=o[0],o.shift();let t=n.split(":");n=t[0],t[1]&&(r=parseInt(Number(t[1])))}let h={},c="",a=[];o[o.length-1]&&(a=o[o.length-1].split("?"));let l=null;a&&a[0]&&(l=a[0].split("."),a[1]&&(o[o.length-1]=a[0]));try{e.items.properties.type||(e.items.properties.type={type:"string",minLength:1,maxLength:5,enum:["jpg","jpeg","gif","zip","glb","html","htm","xml","dat","png","js","json","obj","fbx","svg","mp4","pdf","csv","css","woff","otf","webm","webp","ttf"]}),e.items.properties.protocol||(e.items.properties.protocol={type:"string",minLength:1,maxLength:20,enum:["spatialtoolbox","ws","wss","http","https"]}),e.items.properties.query||(e.items.properties.query={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9~!@$%^&*()-_=+|;:,.]"}),e.items.properties.server||(e.items.properties.server={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9~!@$%^&*()-_=+|;:,.]"}),e.items.properties.route||(e.items.properties.route={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9/~!@$%^&*()-_=+|;:,.]*$"}),e.items.properties.port||(e.items.properties.port={type:"number",min:0,max:99999});for(let t=0;t<o.length;t++)e.items.expected.includes(o[t])?(o[t+1]&&(h[o[t]]=o[t+1]),t++):o[t]&&(c=c+"/"+o[t])}catch(t){return null}return a&&a[1]&&(h.query=a[1]),c&&(h.route=c),n&&(h.server=n),s&&(h.protocol=s),r&&(h.port=r),l&&l.length>1&&(h.type=l[l.length-1]),this.validate(h,t.length,e)?h:null};uuidShort=t=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",i="";for(;i.length<t;)i=e.charAt(Math.floor(Math.random()*e.length))+i;return i}}class e extends t{constructor(t,e,i){super();let s=this;this.retryAmount=5,this.timetoRequestPackage=3e3,this.netBeatInterval=1e3,this.networkID=e,this.url=t,this.origin=i,this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.id=0,this.readyState=3,this.rsOld=null,this.packageID=0,this.packageCb={},this.routineIntervalRef=null,this.netBeatIntervalRef=null,this.envNode=!1,this.isServer=!1,this.CbObj=function(t,e,i){this.callback=t,this.time=e,this.retry=0,this.msg=i},this.CbSub=function(t,e){this.route=t,this.socket=e},this.DataPackage=function(t,e,i,s,n,r=null){this.i=r,this.o=t,this.n=e,this.m=i,this.r=s,this.b=n,this.s=null},this.dataPackageSchema={type:"object",items:{properties:{i:{type:["string","null","undefined"],minLength:1,maxLength:22,pattern:"^[A-Za-z0-9_]*$"},o:{type:"string",minLength:1,maxLength:10,enum:["server","client","web","edge","proxy"]},n:{type:"string",minLength:1,maxLength:25,pattern:"^[A-Za-z0-9_]*$"},m:{type:"string",minLength:1,maxLength:10,enum:["beat","action","ping","get","post","put","patch","delete","new","unsub","sub","pub","message","io","res"]},r:{type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9_/?:&+.%=-]*$"},b:{type:["boolean","array","number","string","object"],minLength:0,maxLength:7e7},s:{type:["string","null","undefined"],minLength:0,maxLength:45,pattern:"^[A-Za-z0-9_]*$"}},required:["i","o","n","m","r","b"]}},this.Response=function(t){this.send=e=>{if(t.i){let i=new s.DataPackage(s.origin,t.n,"res",t.r,{},t.i);i.b=e||204,s.send(i)}}},this.router=t=>{let e;try{e=JSON.parse(t)}catch(t){return void console.log("no json")}s.validate(e,t.length,this.dataPackageSchema)?("ping"===e.m&&(s.send(new s.DataPackage(s.origin,e.n,"res",e.r,"pong",e.i)),s.networkID!==e.n&&(s.networkID=e.n,this.emit("network",e.n,s.networkID,e))),e.i&&"res"===e.m?this.packageCb.hasOwnProperty(e.i)&&(this.packageCb[e.i].callback(e.b),delete this.packageCb[e.i]):this.dataPackageSchema.items.properties.m.enum.includes(e.m)&&this.routerCallback(e)):console.log(e,"not allowed")},this.routerCallback=t=>{t.i?this.emit(t.m,t.r,t.b,new this.Response(t)):this.emit(t.m,t.r,t.b)},this.routineIntervalRef=setInterval(function(){this.readyState!==this.CLOSED&&this.readyState||this.isServer||this.connect(this.url,this.networkID,this.origin);for(let t in this.packageCb)this.timetoRequestPackage<Date.now()-this.packageCb[t].time&&this.packageCb.hasOwnProperty(t)&&(this.packageCb[t].retry++,this.retryAmount<this.packageCb[t].retry?delete this.packageCb[t]:(this.packageCb[t].time=Date.now(),this.resend(t)))}.bind(this),this.timetoRequestPackage),this.message=this.new=this.delete=this.patch=this.io=this.put=this.post=this.get=this.action=this.beat=(t,e,i)=>{};for(let t of this.dataPackageSchema.items.properties.m.enum)this[t]=(e,i,s)=>{this.send(new this.DataPackage(this.origin,this.networkID,t,e,i),s)};this.send=(t,e)=>{this.readyState===this.OPEN&&t&&("function"==typeof e?(this.packageID<Number.MAX_SAFE_INTEGER?this.packageID++:this.packageID=0,t.i=this.packageID+this.uuidShort(4),this.packageCb[t.i]=new this.CbObj(e,Date.now(),t)):"res"!==t.m&&(t.i=null),this.socket.send(JSON.stringify(t)))},this.resend=t=>{this.readyState===this.OPEN&&this.packageCb.hasOwnProperty(t)&&this.socket.send(JSON.stringify(this.packageCb[t].msg))},this.stateEmitter=(t,e)=>{this.readyState=e,this.emit(t,e),this.rsOld!==this.readyState&&(this.emit("status",this.readyState),this.rsOld=this.readyState)},this.attachEvents=()=>{this.envNode&&(this.socket.on("connected",(()=>{s.stateEmitter("connected",s.OPEN)})),this.socket.on("connecting",(()=>{s.stateEmitter("connecting",s.CONNECTING)}))),this.socket.onclose=()=>{s.stateEmitter("close",s.CLOSED)},this.socket.onopen=()=>{s.ping(),s.stateEmitter("open",s.OPEN)},this.socket.onerror=t=>{s.emit("error",t)},this.socket.onmessage=t=>{s.router(t.data)},this.close=()=>{this.socket.close(),this.removeAllListeners(),clearInterval(this.routineIntervalRef),clearInterval(this.netBeatIntervalRef)}},this.ping=()=>{let t=new s.DataPackage(this.origin,this.networkID,"ping","action/ping","");if(s.readyState===this.OPEN)try{s.send(t,(t=>{s.readyState="pong"===t||""===t?s.OPEN:s.CLOSED}),s.socket)}catch(t){s.readyState=s.CLOSED,console.log(t)}else s.readyState=s.CLOSED},this.setNetworkId=t=>this.networkID=t}}class i extends t{constructor(){super(),this.network=null,this.origin=null,this.socket=null,this.id=0,this.routeSchema={type:"object",items:{properties:{n:{type:"string",minLength:1,maxLength:25,pattern:"^[A-Za-z0-9_]*$"}},required:["n"],expected:["n"]}}}attachEvents(){this.socket.on("connected",(()=>{this.returnObject.connected=!0,this.emit("connected"),this.emit("connection"),this.emit("connect")})),this.socket.on("connecting",(()=>{this.emit("connecting")})),this.socket.on("close",(()=>{this.emit("disconnect"),this.returnObject.connected=!1,this.sockets&&this.sockets.connected&&this.returnObject&&this.returnObject.id&&delete this.sockets.connected[this.returnObject.id],this.emit("close"),this.removeAllListeners()})),this.socket.on("open",(()=>{this.returnObject.connected=!0,this.emit("connect"),this.emit("connection")})),this.socket.on("error",(t=>{this.emit("error",t)})),this.socket.on("io",((t,e)=>{this.emit(t,e)}))}connect(t,e,i){if(this.socket&&(this.returnObject.connected=!1,this.socket.close(),this.removeAllListeners()),this.origin="server",this.network="io",e&&(this.network=e),i&&(this.origin=i),"undefined"!=typeof window&&(this.origin="web"),!t&&"undefined"!=typeof window){let e={route:location.pathname,port:location.port,ip:location.hostname,protocol:location.protocol,ws:"ws://"};"https:"===e.protocol?e.ws="wss://":"http:"===e.protocol&&(e.ws="ws://"),t=e.ws+e.ip+":"+e.port+e.route}0===t.indexOf("http")&&(t=t.replace("http","ws"));let n=this.parseUrl(t,this.routeSchema);n&&n.n&&!e&&(this.network=n.n),this.socket=new s(t,this.network,this.origin),this.attachEvents();let r=this;return this.returnObject={on:(t,e)=>r.on(t,(t=>e(t))),emit:(t,e)=>r.socket.io(t,e),connected:!1},this.returnObject}}class s extends e{constructor(t,e,i){super(t,e,i);let s=this;if(this.WebSocket=null,this.socket=null,"undefined"==typeof window)this.WebSocket=require("ws"),this.envNode=!0;else if("undefined"!=typeof WebSocket)this.WebSocket=WebSocket;else if("undefined"!=typeof MozWebSocket)this.WebSocket=MozWebSocket;else if("undefined"!=typeof global)this.WebSocket=global.WebSocket||global.MozWebSocket;else if("undefined"!=typeof window)this.WebSocket=window.WebSocket||window.MozWebSocket;else{if("undefined"==typeof self)return void console.log("websocket not available");this.WebSocket=self.WebSocket||self.MozWebSocket}this.netBeatIntervalRef=setInterval((()=>{s.readyState===s.OPEN&&s.ping()}),s.netBeatInterval),this.connect=(t,e,i)=>{e&&(s.networkID=e),i&&(s.origin=i),s.socket&&(s.readyState=s.CLOSED,s.socket.close()),s.socket=new s.WebSocket(t),s.readyState=s.CONNECTING,this.attachEvents()},this.connect(this.url,this.networkID,this.origin)}static Server=class extends t{constructor(t,i){if(super(),this.origin=i||"server","undefined"!=typeof window)return;let s=this;console.log("ToolSocket Server Start");let n=require("ws");this.server=new n.Server(t),this.server.on("connection",((t,...i)=>{s.emit("connection",new class extends e{constructor(t){super(void 0,void 0,s.origin),this._socket=t._socket,this.socket=t,this.envNode=!0,this.isServer=!0,this.readyState=this.OPEN,this.attachEvents()}}(t),...i)}))}};static Io=class extends i{constructor(t,e,i){super(t,e,i)}static Server=class extends t{constructor(t,e){if(super(),this.origin=e||"server","undefined"!=typeof window)return;let n=this;console.log("IO is waiting for ToolSocket Server"),this.id=1,this.sockets={connected:{}},this.server=new s.Server(t),this.server.on("connection",((t,...e)=>{n.id>=Number.MAX_SAFE_INTEGER&&(n.id=1),n.id++,n.sockets.connected[n.id]=new class extends i{constructor(t,...e){return super(t,...e),this.socket=t,this.sockets=n.sockets,this.socket.networkID="io",this.envNode=!0,this.isServer=!0,this.connect()}connect(){let t=this;return this.attachEvents(),this.returnObject={on:(e,i)=>t.on(e,(t=>i(t))),emit:(e,i)=>t.socket.io(e,i),connected:!0},this.returnObject}}(t),n.sockets.connected[n.id].id=n.id,n.emit("connection",n.sockets.connected[n.id],...e)}))}}}}if("undefined"==typeof window)module.exports=s;else var n=new s.Io;