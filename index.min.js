class e{constructor(){this.eCb={}}on(e,...t){this.eCb[e]||(this.eCb[e]=[]),this.eCb[e].push(...t)}emit(e,...t){this.eCb[e]&&this.eCb[e].forEach((e=>e(...t)))}removeAllListeners(){for(let e in this.eCb)delete this.eCb[e]}}class t extends e{constructor(e,t,i){super();let s=this;this.retryAmount=5,this.timetoRequestPackage=3e3,this.netBeatInterval=1e3,this.networkID=t,this.url=e,this.orging=i,this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.readyState=3,this.rsOld=null,this.packageID=0,this.packageCb={},this.routineIntervalRef=null,this.netBeatIntervalRef=null,this.envNode=!1,this.isServer=!1,this.CbObj=function(e,t,i){this.callback=e,this.time=t,this.retry=0,this.msg=i},this.CbSub=function(e,t){this.route=e,this.socket=t},this.DataPackage=function(e,t,i,s,n,r=null){this.i=r,this.o=e,this.n=t,this.m=i,this.r=s,this.b=n,this.s=null},this.dataPackageSchema={type:"object",items:{properties:{i:{type:["integer","null"],minimum:0,maximum:Number.MAX_SAFE_INTEGER},o:{type:"string",minLength:1,maxLength:10,enum:["server","client","web"]},n:{type:"string",minLength:1,maxLength:25,pattern:"^[A-Za-z0-9_]*$"},m:{type:"string",minLength:1,maxLength:10,enum:["beat","action","ping","get","post","put","patch","delete","new","unsub","sub","pub","message","res"]},r:{type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9_/?:&+.%=-]*$"},b:{type:["boolean","array","number","string","object"],minLength:0,maxLength:7e7},s:{type:["string","null","undefined"],minLength:0,maxLength:45,pattern:"^[A-Za-z0-9_]*$"}},required:["i","o","n","m","r","b"]}},this.Response=function(e){this.send=t=>{if(e.i){let i=new s.DataPackage(s.origin,e.n,"res",e.r,{},e.i);i.b=t||204,s.send(i)}}},this.validate=(e,t,i)=>{if("object"!=typeof e)return!1;let s=(e,t,i)=>"string"==typeof e[i]&&(!(Number.isInteger(t[i].minLength)&&e[i].length<t[i].minLength)&&(!(Number.isInteger(t[i].maxLength)&&e[i].length>t[i].maxLength)&&(!(t[i].pattern&&!e[i].match(t[i].pattern))&&!(t[i].enum&&!t[i].enum.includes(e[i]))))),n=(e,t,i)=>!!Number.isInteger(e[i])&&(!(Number.isInteger(t[i].minimum)&&e[i]<t[i].minimum)&&!(Number.isInteger(t[i].maximum)&&e[i]>t[i].maximum)),r=(e,t,i)=>("res"!==e.m||null!==e[i])&&null===e[i],a=(e,t,i)=>"boolean"==typeof e[i],o=(e,t,i)=>"number"==typeof e[i],h=(e,t,i)=>!e[i],c=(e,t,i,s)=>!!Array.isArray(e[i])&&(!(Number.isInteger(t[i].minLength)&&s<t[i].minLength)&&!(Number.isInteger(t[i].maxLength)&&s>t[i].maxLength)),l=(e,t,i,s)=>{if("object"==typeof e[i])return!(Number.isInteger(t[i].minLength)&&s<t[i].minLength)&&!(Number.isInteger(t[i].maxLength)&&s>t[i].maxLength)},g=(e,t,i)=>t.hasOwnProperty(i),m=i.items.properties,u=!0;for(let i in e)if(g(0,m,i)){let g=!1;m[i].type.includes("string")&&s(e,m,i)&&(g=!0),m[i].type.includes("integer")&&n(e,m,i)&&(g=!0),m[i].type.includes("null")&&r(e,0,i)&&(g=!0),m[i].type.includes("boolean")&&a(e,0,i)&&(g=!0),m[i].type.includes("number")&&o(e,0,i)&&(g=!0),m[i].type.includes("array")&&c(e,m,i,t)&&(g=!0),m[i].type.includes("object")&&l(e,m,i,t)&&(g=!0),m[i].type.includes("undefined")&&h(e,0,i)&&(g=!0),g||(u=!1)}else u=!1;return((e,t)=>{for(let i in t)if(!e.hasOwnProperty(t[i]))return!1;return!0})(e,i.items.required)||(u=!1),!u},this.router=e=>{let t;try{t=JSON.parse(e)}catch(e){return void console.log("no json")}s.validate(t,e.length,this.dataPackageSchema)?console.log("not allowed"):("ping"===t.m&&(s.send(new s.DataPackage(s.origin,t.n,"res",t.r,"pong",t.i)),s.networkID!==t.n&&(this.emit("network",t.n,s.networkID),s.networkID=t.n)),t.i&&"res"===t.m?this.packageCb.hasOwnProperty(t.i)&&(this.packageCb[t.i].callback(t.b),delete this.packageCb[t.i]):this.dataPackageSchema.items.properties.m.enum.includes(t.m)&&this.routerCallback(t))},this.routerCallback=e=>{e.i?this.emit(e.m,e.r,e.b,new this.Response(e)):this.emit(e.m,e.r,e.b)},this.routineIntervalRef=setInterval(function(){this.readyState!==this.CLOSED&&this.readyState||this.isServer||this.connect(this.url,this.networkID,this.origin);for(let e in this.packageCb)this.timetoRequestPackage<Date.now()-this.packageCb[e].time&&this.packageCb.hasOwnProperty(e)&&(this.packageCb[e].retry++,this.retryAmount<this.packageCb[e].retry?delete this.packageCb[e]:(this.packageCb[e].time=Date.now(),this.resend(e)))}.bind(this),this.timetoRequestPackage),this.message=this.new=this.delete=this.patch=this.put=this.post=this.get=this.action=this.beat=(e,t,i)=>{};for(let e of this.dataPackageSchema.items.properties.m.enum)this[e]=(t,i,s)=>{this.send(new this.DataPackage(this.origin,this.networkID,e,t,i),s)};this.send=(e,t)=>{this.readyState===this.OPEN&&e&&("function"==typeof t?(this.packageID<Number.MAX_SAFE_INTEGER?this.packageID++:this.packageID=0,e.i=this.packageID,this.packageCb[this.packageID]=new this.CbObj(t,Date.now(),e)):"res"!==e.m&&(e.i=null),this.socket.send(JSON.stringify(e)))},this.resend=e=>{this.readyState===this.OPEN&&this.packageCb.hasOwnProperty(e)&&this.socket.send(JSON.stringify(this.packageCb[e].msg))},this.stateEmitter=(e,t)=>{this.readyState=t,this.emit(e,t),this.rsOld!==this.readyState&&(this.emit("status",this.readyState),this.rsOld=this.readyState)},this.attachEvents=()=>{this.envNode&&(this.socket.on("connected",(()=>{s.stateEmitter("connected",s.OPEN)})),this.socket.on("connecting",(()=>{s.stateEmitter("connecting",s.CONNECTING)}))),this.socket.onclose=()=>{s.stateEmitter("close",s.CLOSED)},this.socket.onopen=()=>{s.ping(),s.stateEmitter("open",s.OPEN)},this.socket.onerror=e=>{s.emit("error",e)},this.socket.onmessage=e=>{s.router(e.data)},this.close=()=>{this.socket.close(),this.removeAllListeners(),clearInterval(this.routineIntervalRef),clearInterval(this.netBeatIntervalRef)}},this.ping=()=>{let e=new s.DataPackage(this.origin,this.networkID,"ping","action/ping","");if(s.readyState===this.OPEN)try{s.send(e,(e=>{s.readyState="pong"===e||""===e?s.OPEN:s.CLOSED}),s.socket)}catch(e){s.readyState=s.CLOSED,console.log(e)}else s.readyState=s.CLOSED},this.setNetworkId=e=>this.networkID=e}}class i extends t{constructor(e,t,i){super();let s=this;if(this.url=e,this.networkID=t,this.origin=i,this.WebSocket=null,this.socket=null,"undefined"==typeof window)this.WebSocket=require("ws"),this.envNode=!0;else if("undefined"!=typeof WebSocket)this.WebSocket=WebSocket;else if("undefined"!=typeof MozWebSocket)this.WebSocket=MozWebSocket;else if("undefined"!=typeof global)this.WebSocket=global.WebSocket||global.MozWebSocket;else if("undefined"!=typeof window)this.WebSocket=window.WebSocket||window.MozWebSocket;else{if("undefined"==typeof self)return void console.log("websocket not available");this.WebSocket=self.WebSocket||self.MozWebSocket}this.netBeatIntervalRef=setInterval((()=>{s.readyState===s.OPEN&&s.ping()}),s.netBeatInterval),this.connect=(e,t,i)=>{t&&(s.networkID=t),i&&(s.origin=i),s.socket&&(s.readyState=s.CLOSED,s.socket.close()),s.socket=new s.WebSocket(e),s.readyState=s.CONNECTING,this.attachEvents()},this.connect(this.url,this.networkID,this.origin)}static Server=class extends e{constructor(e,i){if(super(),this.origin=i||"server","undefined"!=typeof window)return;let s=this;console.log("Server init");let n=require("ws");this.server=new n.Server(e),this.server.on("connection",((e,...i)=>{s.emit("connection",new class extends t{constructor(e){super(),this._socket=e._socket,this.socket=e,this.envNode=!0,this.isServer=!0,this.readyState=this.OPEN,this.origin=s.origin,this.attachEvents()}}(e),...i)}))}}}"undefined"==typeof window&&(module.exports=i);